{% extends "base.html" %}
{% block content %}
<div class="text-center">
  <h2 class="mb-3">{{ titulo }}</h2>

  <div class="salmo-texto text-start">
    {{ texto }}
  </div>

  <div class="mt-4 d-flex flex-column align-items-center gap-3">

    <!-- Bot칚o de voz -->
    <button class="btn btn-outline-warning" id="btnOuvir" onclick="ouvirSalmo()">游댉 Ouvir Salmo</button>
    <audio id="audioSalmo" controls hidden></audio>

    <!-- Enviar pelo WhatsApp -->
    <div class="mt-3">
      <button class="btn btn-outline-success" onclick="enviarWhatsApp()">游눫 Compartilhar no WhatsApp</button>
    </div>    

    <!-- Enviar por e-mail -->
    <div class="mt-4 text-start border rounded p-3" style="max-width: 420px;">
      <label for="email" class="form-label">游닎 Enviar por E-mail:</label>
      <div class="d-flex">
        <input type="email" id="email" class="form-control me-2" placeholder="Digite seu e-mail">
        <button class="btn btn-success" onclick="enviarEmail()">Enviar</button>
      </div>
      <small id="emailStatus" class="text-muted"></small>
    </div>

    <a href="/" class="btn btn-outline-primary mt-3">拘勇 Voltar</a>
  </div>
  <div id="salmoData" data-text="{{ texto | e('html_attr') }}"></div>
</div>

<script>

  const salmoTexto = document.getElementById('salmoData').dataset.text || "";

 async function ouvirSalmo() {
    const botao = document.getElementById("btnOuvir");
    const audio = document.getElementById("audioSalmo");

    botao.disabled = true;
    botao.innerText = "游꿚 Gerando 치udio...";

    try {
      // cheque no console se o texto chegou corretamente
      console.log("salmoTexto:", salmoTexto);

      const res = await fetch("/voz", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ texto: salmoTexto })
      });

      // verificar status e json
      if (!res.ok) {
        const txt = await res.text();
        console.error("Resposta /voz n칚o OK:", res.status, txt);
        botao.innerText = "Erro ao gerar 치udio";
        botao.disabled = false;
        return;
      }

      const data = await res.json();
      console.log("Resposta /voz:", data);

      if (data.audio_url) {
        audio.src = data.audio_url + "?t=" + Date.now();
        audio.hidden = false;
        await audio.play();
        botao.innerText = "游댉 Reproduzindo...";
      } else {
        botao.innerText = "Erro ao gerar 치udio";
      }
    } catch (err) {
      console.error("Erro no ouvirSalmo:", err);
      botao.innerText = "Erro na reprodu칞칚o";
    } finally {
      botao.disabled = false;
    }
  }

async function enviarEmail() {
  const email = document.getElementById("email").value;
  const status = document.getElementById("emailStatus");
  if (!email) {
    status.innerText = "Digite um e-mail v치lido.";
    return;
  }
  status.innerText = "Enviando...";
  const texto = `{{ texto | safe }}`;
  const res = await fetch("/enviar-email", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ email, texto })
  });
  const data = await res.json();
  status.innerText = data.message || "Erro ao enviar.";
}

function enviarWhatsApp() {
  const texto = encodeURIComponent(`{{ texto }}`);
  const url = `https://api.whatsapp.com/send?text=${texto}`;
  window.open(url, "_blank");
}
</script>
{% endblock %}
